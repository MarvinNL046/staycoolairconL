<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Facebook Conversions API</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    button {
      background: #1877f2;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background: #166fe5;
    }
    pre {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .success {
      color: #059669;
    }
    .error {
      color: #dc2626;
    }
  </style>
</head>
<body>
  <h1>Test Facebook Conversions API</h1>
  <p>Click the button below to send a test event to the Conversions API:</p>
  
  <button onclick="sendTestEvent()">Send Test Event</button>
  
  <div id="result"></div>
  
  <script>
    // Calculate Event Match Quality score
    function calculateEMQ(userData) {
      let score = 0;
      const weights = {
        em: 2,      // email
        ph: 2,      // phone
        fn: 1,      // first name
        ln: 1,      // last name
        ct: 0.5,    // city
        st: 0.5,    // state
        zp: 0.5,    // zip
        country: 0.5,
        external_id: 1.5,
        fbp: 0.5,   // browser ID
        fbc: 1,     // click ID
      };
      
      Object.entries(weights).forEach(([field, weight]) => {
        if (userData[field]) {
          score += weight;
        }
      });
      
      return Math.min(score, 10); // Cap at 10
    }
    
    async function sendTestEvent() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<p>Sending test event...</p>';
      
      // Generate test event with high quality data
      const eventId = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      const testData = {
        event_name: 'Lead',
        event_time: Math.floor(Date.now() / 1000),
        event_id: eventId,
        user_data: {
          em: 'f660ab912ec121d1b1e928a0bb4bc61b15f5ad44d5efdc4e1c92a25e99b8e44a', // test@example.com hashed
          ph: '0c2f66a69420954c6b893c2afaae3dc3de0e5a4e7871026969ebcd637f0d3ab9', // +31612345678 hashed
          fn: '0b14d501a594442a01c6859541bcb3e8164d183d32937b851835442f69d5c94e', // john hashed
          ln: '96d9632f363564cc3032521409cf22a852f2032eec099ed5967c0d000cec607a', // doe hashed
          ct: 'cc0dff72a14b80e4b32e387e1b917b8e4c2709b21c5cf5907cf5c962eebe70f2', // maastricht hashed
          st: '4f877a042c6b5d6f15a69b4c4e95bd39f8863c0b6a3faea88bb088cf7cf30077', // limburg hashed
          zp: '96821dc6c23bf916f51e821c64c8c046cbf9c03e659ad0a13c6f8a5afcd33275', // 6211 hashed
          country: '5f8dd236f4f71fa24c00f6e27623dc9b298fae2f8a640485cbf019de7b543f12', // nl hashed
          external_id: '9b9c5b6bb6c7b1e3b9e0b1b7b5b1b5b9', // test external id hashed
          client_ip_address: '', // Will be set by server
          client_user_agent: navigator.userAgent,
          fbp: 'fb.1.1558571054389.1098115397',
          fbc: 'fb.1.1554763741205.AbCdEfGhIjKlMnOpQrStUvWxYz1234567890'
        },
        custom_data: {
          value: 1650.0,
          currency: 'EUR',
          content_name: 'test_form',
          content_category: 'airco_installation'
        },
        action_source: 'website',
        event_source_url: window.location.href
      };
      
      // Calculate Event Match Quality Score
      const emqScore = calculateEMQ(testData.user_data);
      
      console.log('Test event data:', testData);
      console.log('Event Match Quality Score:', emqScore);
      
      try {
        const response = await fetch('/.netlify/functions/facebook-conversion', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(testData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          resultDiv.innerHTML = `
            <h3 class="success">✅ Success!</h3>
            <p>Event sent successfully to Facebook Conversions API.</p>
            <h4>Response:</h4>
            <pre>${JSON.stringify(result, null, 2)}</pre>
            <h4>Event Quality Metrics:</h4>
            <ul>
              <li><strong>Event ID:</strong> ${eventId}</li>
              <li><strong>Event Freshness:</strong> Real-time (0 seconds)</li>
              <li><strong>Event Match Quality Score:</strong> ${emqScore}/10 ${emqScore >= 6 ? '✅' : '⚠️ (Target: 6.0+)'}</li>
              <li><strong>User Data Fields:</strong> ${Object.keys(testData.user_data).filter(k => k !== 'client_ip_address' && k !== 'client_user_agent').length}</li>
            </ul>
            <p>Now check Facebook Events Manager to verify:</p>
            <ol>
              <li>Event was received in "Test Events" tab</li>
              <li>Event Match Quality score in "Overview"</li>
              <li>Deduplication rate if sending from both Pixel and API</li>
            </ol>
          `;
        } else {
          resultDiv.innerHTML = `
            <h3 class="error">❌ Error</h3>
            <p>Failed to send event.</p>
            <h4>Error Details:</h4>
            <pre>${JSON.stringify(result, null, 2)}</pre>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <h3 class="error">❌ Network Error</h3>
          <p>Failed to connect to the function.</p>
          <h4>Error:</h4>
          <pre>${error.message}</pre>
        `;
      }
    }
  </script>
</body>
</html>